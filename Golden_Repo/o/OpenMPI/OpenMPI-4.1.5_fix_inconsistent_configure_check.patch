From 5b4ee66322fdee73297f73319f831a1960f81aa6 Mon Sep 17 00:00:00 2001
From: Sergey Kosukhin <sergey.kosukhin@mpimet.mpg.de>
Date: Tue, 15 Aug 2023 19:05:13 +0200
Subject: [PATCH] Fix inconsistent configure-time Fortran TKR check

This fixes the inconsistency between what is tested at the configure time (the
unnamed Fortran interface) and what is actually used in the source code (the
named Fortran interface).

As was mentioned in #9445, the unnamed interfaces are more forgiving when it
comes to TKR mismatches. Therefore, the current configure-time check is not
strict enough and is prone to giving false results (e.g. for NVHPC 23.3+). The
fix is to switch to the named Fortran interface in the configure script.

Note that the inconsistency was resolved in the main branch with #9445, which we
cannot cherry-pick because it potentially breaks the ABI compatibility.

Signed-off-by: Sergey Kosukhin <sergey.kosukhin@mpimet.mpg.de>
---
 config/ompi_fortran_check_ignore_tkr.m4 | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/config/ompi_fortran_check_ignore_tkr.m4 b/config/ompi_fortran_check_ignore_tkr.m4
index bb64eb50565..d9965376098 100644
--- a/config/ompi_fortran_check_ignore_tkr.m4
+++ b/config/ompi_fortran_check_ignore_tkr.m4
@@ -141,7 +141,7 @@ AC_DEFUN([OMPI_FORTRAN_CHECK_IGNORE_TKR_SUB], [
      end subroutine force_assumed_shape
   end interface
 
-  interface
+  interface foo
      subroutine foo(buffer, count)
        $1 buffer
        $2, intent(in) :: buffer
