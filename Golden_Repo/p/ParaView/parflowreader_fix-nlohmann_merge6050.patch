From 1a32dd6fc394a75b6898b1d692157826ed235015 Mon Sep 17 00:00:00 2001
From: David Thompson <david.thompson@kitware.com>
Date: Sat, 3 Dec 2022 01:08:56 -0500
Subject: [PATCH 1/2] Make the ParFlow Plugin work with modern nlohmann::json.

The previous version worked with nlohmann::json v3.6.1 but
is broken using v3.11.2. Rather than attempt to throw internal
nlohmann::json exception types, throw standard C++ exceptions
for our errors.
---
 Plugins/ParFlow/IO/vtkVectorJSON.h | 7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

diff --git a/Plugins/ParFlow/IO/vtkVectorJSON.h b/Plugins/ParFlow/IO/vtkVectorJSON.h
index 8e4d23c7e4..fb7fb5ecdb 100644
--- a/Plugins/ParFlow/IO/vtkVectorJSON.h
+++ b/Plugins/ParFlow/IO/vtkVectorJSON.h
@@ -6,6 +6,8 @@
 
 #include "nlohmann/json.hpp" // for json
 
+#include <stdexcept>
+
 /// Convert a vtkVector (or any vtkTuple) into a json::array.
 template <typename T, int S>
 void to_json(nlohmann::json& j, const vtkTuple<T, S>& vec)
@@ -19,12 +21,11 @@ void from_json(const nlohmann::json& j, vtkTuple<T, S>& vec)
 {
   if (!j.is_array())
   {
-    throw nlohmann::detail::type_error::create(
-      302, "type must be array, but is " + std::string(j.type_name()));
+    throw std::invalid_argument("type must be array, but is " + std::string(j.type_name()));
   }
   if (static_cast<int>(j.size()) != vec.GetSize())
   {
-    throw nlohmann::detail::type_error::create(302, "array sizes do not match");
+    throw std::invalid_argument("array sizes do not match");
   }
   int ii = 0;
   for (auto it = j.begin(); it != j.end(); ++it, ++ii)
-- 
GitLab


From e7a0cb1c336fae38c41987e20ee2834eca034ae9 Mon Sep 17 00:00:00 2001
From: David Thompson <david.thompson@kitware.com>
Date: Sat, 3 Dec 2022 01:28:27 -0500
Subject: [PATCH 2/2] Switch the ParFlow plugin to VTK's nlohmann::json.

Using this version allows us to enable the plugin by
default since it doesn't add any external dependencies.
---
 CMakeLists.txt                              | 2 +-
 Plugins/ParFlow/IO/CMakeLists.txt           | 7 -------
 Plugins/ParFlow/IO/vtk.module               | 1 +
 Plugins/ParFlow/IO/vtkParFlowMetaReader.cxx | 7 ++++++-
 Plugins/ParFlow/IO/vtkParFlowMetaReader.h   | 5 +++++
 Plugins/ParFlow/IO/vtkVectorJSON.h          | 5 +++++
 6 files changed, 18 insertions(+), 9 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 2674a59e83..e28ee1a594 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -312,7 +312,7 @@ set(paraview_default_plugins
   PacMan
   PanoramicProjectionView
   ParametricSurfaces
-  # ParFlow - Because of dependency to nlohmann_json
+  ParFlow
   SaveStateAndScreenshot
   SLACTools
   StreamLinesRepresentation
diff --git a/Plugins/ParFlow/IO/CMakeLists.txt b/Plugins/ParFlow/IO/CMakeLists.txt
index ddafa4e6ab..733fd6cfc4 100644
--- a/Plugins/ParFlow/IO/CMakeLists.txt
+++ b/Plugins/ParFlow/IO/CMakeLists.txt
@@ -7,17 +7,10 @@ set(private_headers
   vtkVectorJSON.h
 )
 
-vtk_module_find_package(
-  PACKAGE nlohmann_json)
-
 vtk_module_add_module(ParFlow::IO
   CLASSES ${classes}
   PRIVATE_HEADERS ${private_headers}
 )
-vtk_module_link(ParFlow::IO
-  PUBLIC nlohmann_json::nlohmann_json
-)
-
 paraview_add_server_manager_xmls(
   XMLS  ParFlowIO.xml
 )
diff --git a/Plugins/ParFlow/IO/vtk.module b/Plugins/ParFlow/IO/vtk.module
index ea43242296..2caca0ba91 100644
--- a/Plugins/ParFlow/IO/vtk.module
+++ b/Plugins/ParFlow/IO/vtk.module
@@ -8,3 +8,4 @@ DEPENDS
   VTK::CommonDataModel
   VTK::CommonExecutionModel
   VTK::ParallelCore
+  VTK::nlohmannjson
diff --git a/Plugins/ParFlow/IO/vtkParFlowMetaReader.cxx b/Plugins/ParFlow/IO/vtkParFlowMetaReader.cxx
index ba33a5eb77..06805bdf7d 100644
--- a/Plugins/ParFlow/IO/vtkParFlowMetaReader.cxx
+++ b/Plugins/ParFlow/IO/vtkParFlowMetaReader.cxx
@@ -25,7 +25,12 @@
 #include "vtksys/FStream.hxx"
 #include "vtksys/SystemTools.hxx"
 
-#include "nlohmann/json.hpp"
+#if 0
+#include "nlohmann/json.hpp" // for json bits
+#else
+#include "vtk_nlohmannjson.h"        // Use VTK's mangled version
+#include VTK_NLOHMANN_JSON(json.hpp) // Use VTK's mangled version
+#endif
 
 #include <algorithm>
 #include <cmath>
diff --git a/Plugins/ParFlow/IO/vtkParFlowMetaReader.h b/Plugins/ParFlow/IO/vtkParFlowMetaReader.h
index 3fc07ca58c..ace47939ee 100644
--- a/Plugins/ParFlow/IO/vtkParFlowMetaReader.h
+++ b/Plugins/ParFlow/IO/vtkParFlowMetaReader.h
@@ -8,7 +8,12 @@
 #include "vtkSmartPointer.h" // for ivars
 #include "vtkVector.h"       // for vtkVector*
 
+#if 0
 #include "nlohmann/json.hpp" // for json bits
+#else
+#include "vtk_nlohmannjson.h"        // Use VTK's mangled version
+#include VTK_NLOHMANN_JSON(json.hpp) // Use VTK's mangled version
+#endif
 
 #include <map>    // for std::map
 #include <set>    // for std::set
diff --git a/Plugins/ParFlow/IO/vtkVectorJSON.h b/Plugins/ParFlow/IO/vtkVectorJSON.h
index fb7fb5ecdb..57b39e94a1 100644
--- a/Plugins/ParFlow/IO/vtkVectorJSON.h
+++ b/Plugins/ParFlow/IO/vtkVectorJSON.h
@@ -4,7 +4,12 @@
 
 #include "vtkVector.h"
 
+#if 0
 #include "nlohmann/json.hpp" // for json
+#else
+#include "vtk_nlohmannjson.h"        // Use VTK's mangled version
+#include VTK_NLOHMANN_JSON(json.hpp) // Use VTK's mangled version
+#endif
 
 #include <stdexcept>
 
-- 
GitLab

